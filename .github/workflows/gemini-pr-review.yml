name: Gemini PR Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Get PR diff
        id: diff
        run: |
          git fetch origin pull/${{ github.event.pull_request.number }}/head:pr-branch
          DIFF=$(git diff origin/main...pr-branch | head -c 3000)
          echo "diff=$DIFF" >> $GITHUB_OUTPUT
      
      - name: Review with Gemini
        id: review
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          PR_DIFF: ${{ steps.diff.outputs.diff }}
        run: |
          python3 << 'PYTHON_EOF'
          import os
          import json
          import urllib.request
          
          api_key = os.getenv('GEMINI_API_KEY')
          diff = os.getenv('PR_DIFF')
          
          if not api_key or not diff:
              print("Missing API key or diff")
              exit(1)
          
          prompt = f"""Review this code diff and provide feedback on:
1. Security issues
2. Code quality
3. Best practices
4. Positive observations

Diff:
{diff}"""
          
          data = json.dumps({
              "contents": [{
                  "parts": [{"text": prompt}]
              }]
          }).encode('utf-8')
          
          url = f"https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key={api_key}"
          
          try:
              req = urllib.request.Request(url, data=data, headers={'Content-Type': 'application/json'})
              with urllib.request.urlopen(req) as response:
                  result = json.loads(response.read().decode('utf-8'))
                  review = result['candidates'][0]['content']['parts'][0]['text']
                  with open('review.txt', 'w') as f:
                      f.write(review)
              print("Review completed")
          except Exception as e:
              print(f"Error: {e}")
              exit(1)
          PYTHON_EOF
      
      - name: Post review comment
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            try {
              const review = fs.readFileSync('review.txt', 'utf8');
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `## Gemini AI Code Review\n\n${review}`
              });
            } catch (error) {
              console.log('Could not post review comment');
            }
